<?xml version="1.0" encoding="UTF-8"?>
<!--
  VICE Snapshot to PRG Converter - WiX Installer Configuration

  This installer creates the following structure:
  Program Files\vice-snapshot-to-prg-converter\
  ├── vice-snapshot-to-prg-converter.exe (GUI)
  ├── vice-snapshot-to-prg-converter-cli.exe (CLI)
  └── vcruntime140.dll (only if VC++ Redistributable not installed)
-->

<?if $(sys.BUILDARCH) = x64 or $(sys.BUILDARCH) = arm64 ?>
    <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
<?else ?>
    <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
<?endif ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

    <Product
        Id="*"
        Name="VICE Snapshot to PRG Converter"
        UpgradeCode="43A96CCD-119B-4466-AC9A-74BBC3EBF64E"
        Manufacturer="Tommy Olsen"
        Language="1033"
        Codepage="1252"
        Version="$(var.Version)">

        <Package Id="*"
            Keywords="Installer"
            Description="Converts VICE 3.9 x64sc snapshots to self-restoring C64 PRG files"
            Manufacturer="Tommy Olsen"
            InstallerVersion="450"
            Languages="1033"
            Compressed="yes"
            InstallScope="perMachine"
            SummaryCodepage="1252"
            />

        <MajorUpgrade
            Schedule="afterInstallInitialize"
            DowngradeErrorMessage="A newer version of [ProductName] is already installed. Setup will now exit."/>

        <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" DiskPrompt="CD-ROM #1"/>
        <Property Id="DiskPrompt" Value="VICE Snapshot to PRG Converter Installation"/>

        <!-- Check if VC++ Redistributable is already installed -->
        <Property Id="VCREDIST_INSTALLED">
            <RegistrySearch Id="VCRedist2015Plus_x64"
                Root="HKLM"
                Key="SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x64"
                Name="Installed"
                Type="raw" />
        </Property>

        <!-- Set the installation directory property for WixUI_InstallDir -->
        <Property Id="WIXUI_INSTALLDIR" Value="APPLICATIONFOLDER" />

        <!-- Set default installation location -->
        <SetProperty Id="ARPINSTALLLOCATION" Value="[APPLICATIONFOLDER]" After="CostFinalize"/>

        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="$(var.PlatformProgramFilesFolder)" Name="PFiles">
                <Directory Id="APPLICATIONFOLDER" Name="vice-snapshot-to-prg-converter">

                    <!-- Main GUI executable -->
                    <Component Id="MainExecutable" Guid="*">
                        <File
                            Id="MainExe"
                            Name="vice-snapshot-to-prg-converter.exe"
                            DiskId="1"
                            Source="$(var.CargoTargetBinDir)\vice-snapshot-to-prg-converter.exe"
                            KeyPath="yes"/>
                    </Component>

                    <!-- CLI executable -->
                    <Component Id="CliExecutable" Guid="*">
                        <File
                            Id="CliExe"
                            Name="vice-snapshot-to-prg-converter-cli.exe"
                            DiskId="1"
                            Source="$(var.CargoTargetBinDir)\vice-snapshot-to-prg-converter-cli.exe"
                            KeyPath="yes"/>
                    </Component>

                    <!-- VC++ Runtime DLL - only installed if VC++ Redistributable is not present -->
                    <Component Id="VCRuntime" Guid="*">
                        <Condition>NOT VCREDIST_INSTALLED</Condition>
                        <File
                            Id="VCRuntime140"
                            Name="vcruntime140.dll"
                            DiskId="1"
                            Source="external-utils\vcruntime140.dll"
                            KeyPath="yes"/>
                    </Component>

                </Directory>
            </Directory>

            <!-- Desktop shortcut (GUI only) -->
            <Directory Id="DesktopFolder" Name="Desktop">
                <Component Id="DesktopShortcut" Guid="B8F4C3D2-8E9A-4F1B-9C2D-3E4F5A6B7C8D">
                    <Shortcut
                        Id="DesktopShortcut"
                        Name="VICE Snapshot to PRG Converter"
                        Description="Convert VICE snapshots to C64 PRG files"
                        Target="[APPLICATIONFOLDER]vice-snapshot-to-prg-converter.exe"
                        WorkingDirectory="APPLICATIONFOLDER"/>
                    <RemoveFolder Id="RemoveDesktopFolder" On="uninstall"/>
                    <RegistryValue
                        Root="HKCU"
                        Key="Software\Commodore 64 Tools\ViceSnapshotConverter"
                        Name="DesktopShortcut"
                        Type="integer"
                        Value="1"
                        KeyPath="yes"/>
                </Component>
            </Directory>

            <!-- Start Menu shortcuts -->
            <Directory Id="ProgramMenuFolder">
                <Directory Id="ApplicationProgramsFolder" Name="VICE Snapshot to PRG Converter">
                    <Component Id="StartMenuShortcuts" Guid="C9F5D4E3-9F0B-5A2C-AD3E-4F5A6B7C8D9E">
                        <!-- GUI shortcut -->
                        <Shortcut
                            Id="ApplicationStartMenuShortcut"
                            Name="VICE Snapshot to PRG Converter"
                            Description="Convert VICE snapshots to C64 PRG files (GUI)"
                            Target="[APPLICATIONFOLDER]vice-snapshot-to-prg-converter.exe"
                            WorkingDirectory="APPLICATIONFOLDER"/>
                        <!-- CLI shortcut (opens in Command Prompt) -->
                        <Shortcut
                            Id="CliStartMenuShortcut"
                            Name="VICE Snapshot to PRG Converter (Command Prompt)"
                            Description="Open Command Prompt in the installation folder"
                            Target="[System64Folder]cmd.exe"
                            Arguments="/K cd /d &quot;[APPLICATIONFOLDER]&quot; &amp;&amp; echo VICE Snapshot to PRG Converter (CLI) &amp;&amp; echo. &amp;&amp; echo Usage: vice-snapshot-to-prg-converter-cli.exe input.vsf output.prg &amp;&amp; echo Type --help for more information &amp;&amp; echo."
                            WorkingDirectory="APPLICATIONFOLDER"/>
                        <RemoveFolder Id="RemoveApplicationProgramsFolder" On="uninstall"/>
                        <RegistryValue
                            Root="HKCU"
                            Key="Software\Commodore 64 Tools\ViceSnapshotConverter"
                            Name="StartMenuShortcut"
                            Type="integer"
                            Value="1"
                            KeyPath="yes"/>
                    </Component>
                </Directory>
            </Directory>
        </Directory>

        <Feature
            Id="Complete"
            Title="VICE Snapshot to PRG Converter"
            Description="Complete installation of VICE Snapshot to PRG Converter."
            Level="1"
            ConfigurableDirectory="APPLICATIONFOLDER"
            AllowAdvertise="no"
            Display="expand"
            Absent="disallow">

            <!-- Main application -->
            <ComponentRef Id="MainExecutable"/>
            <ComponentRef Id="CliExecutable"/>
            <ComponentRef Id="VCRuntime"/>

            <!-- Shortcuts -->
            <Feature
                Id="Shortcuts"
                Title="Desktop and Start Menu Shortcuts"
                Description="Creates shortcuts on the Desktop and in the Start Menu for easy access."
                Level="1">
                <ComponentRef Id="DesktopShortcut"/>
                <ComponentRef Id="StartMenuShortcuts"/>
            </Feature>
        </Feature>

        <!-- Add/Remove Programs properties -->
        <Property Id="ARPPRODUCTICON" Value="ProductICO" />
        <Property Id="ARPURLINFOABOUT" Value="https://github.com/tommyo123/Vice_Snapshot_to_PRG/"/>
        <Property Id="ARPNOREPAIR" Value="yes" Secure="yes" />

        <!-- Product icon -->
        <Icon Id="ProductICO" SourceFile="res\VICE-SNAPSHOT-TO-PRG-CONVERTER.ICO"/>

        <UI>
            <!-- Use InstallDir UI instead of FeatureTree to allow directory selection -->
            <UIRef Id="WixUI_InstallDir"/>

            <!-- Skip license dialog since this is public domain -->
            <Publish Dialog="WelcomeDlg" Control="Next" Event="NewDialog" Value="InstallDirDlg" Order="2">1</Publish>
            <Publish Dialog="InstallDirDlg" Control="Back" Event="NewDialog" Value="WelcomeDlg" Order="2">1</Publish>
        </UI>

    </Product>

</Wix>
